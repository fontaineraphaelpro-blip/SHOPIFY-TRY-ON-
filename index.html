<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTON AI</title>
    <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js" data-api-key="{{ api_key if api_key else 'DEMO_KEY' }}"></script>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
</head>
<body>

    <div class="app-container">
        <div id="admin-only-zone">
            <header class="glass-header">
                <div class="brand"><div class="logo-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></div><div class="logo-text"><h1>VTON<span>AI</span></h1><span class="badge-beta">PRO DASHBOARD</span></div></div>
                <div class="system-status"><span class="pulse-dot"></span> System Operational</div>
            </header>
            <div class="divider"><span>TRY-ON PREVIEW TOOL</span></div>
        </div>

        <div class="main-content">
            <input type="hidden" id="shopName" name="shop" value="demo-store.myshopify.com">

            <div class="studio-grid">
                
                <label for="person_image" class="studio-box">
                    <div class="step-number">01</div>
                    <img id="prevU" src="" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:12px;">
                    <div class="empty-state">
                        <div class="icon-circle"><i class="fa-solid fa-camera"></i></div>
                        <span class="fashion-font">Your Photo</span>
                    </div>
                    <input type="file" id="person_image" name="person_image" accept="image/*" onchange="preview('person_image', 'prevU')">
                </label>

                <div class="studio-box">
                    <div class="step-number">02</div>
                    <img id="prevC" src="" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:12px;">
                    
                    <div class="empty-state" id="urlInputState">
                        <div class="icon-circle"><i class="fa-solid fa-link"></i></div>
                        <span class="fashion-font">Garment URL</span>
                        <input type="text" id="clothing_url" name="clothing_url" 
                               placeholder="Paste image URL..." 
                               style="width: 80%; margin-top:10px; padding:5px; border-radius:5px; border:1px solid #ccc; font-size:12px;"
                               onchange="previewUrl(this.value, 'prevC')">
                    </div>
                </div>

            </div>

            <div class="action-area">
                <button id="btnGo" onclick="generate()" class="btn-magic">
                    <span class="btn-content">Try It On Now <i class="fa-solid fa-wand-magic-sparkles"></i></span>
                    <div class="btn-glow"></div>
                </button>
            </div>

            <div id="resZone" style="display:none;" class="result-display">
                <div id="loader" style="display:none;">
                    <div class="spinner-modern"></div>
                    <p id="loader-text" class="fashion-loader-text">Analyzing silhouette...</p>
                </div>
                <img id="resImg" src="" style="display:none;">
                
                <div id="post-actions" style="display:none;" class="post-result-actions">
                    <button id="shopBtn" class="btn-shop-now">Shop This Look <i class="fa-solid fa-bag-shopping"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fonction simple de prévisualisation image locale
        function preview(inputId, imgId) {
            const file = document.getElementById(inputId).files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.style.display = 'block';
                    // Cache l'état vide
                    img.parentElement.querySelector('.empty-state').style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }

        // Nouvelle fonction pour prévisualiser l'URL du vêtement
        function previewUrl(url, imgId) {
            if(url) {
                const img = document.getElementById(imgId);
                img.src = url;
                img.style.display = 'block';
                document.getElementById('urlInputState').style.opacity = '0'; // Masque le texte pour voir l'image
            }
        }

        async function generate() {
            // 1. Récupération des données
            const shop = document.getElementById('shopName').value;
            const personFile = document.getElementById('person_image').files[0];
            const clothingUrl = document.getElementById('clothing_url').value;

            // Validation simple
            if (!personFile || !clothingUrl) {
                alert("Please upload a photo AND provide a clothing URL.");
                return;
            }

            // 2. Préparation UI
            document.getElementById('resZone').style.display = 'block';
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('resImg').style.display = 'none';
            document.getElementById('btnGo').disabled = true;

            // 3. Création du FormData pour Python
            const formData = new FormData();
            formData.append('shop', shop);
            formData.append('person_image', personFile); // Envoi du fichier
            formData.append('clothing_url', clothingUrl); // Envoi de l'URL texte

            try {
                // 4. Appel au serveur Python
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    // Succès !
                    document.getElementById('resImg').src = data.result_image_url;
                    document.getElementById('resImg').style.display = 'block';
                    document.getElementById('post-actions').style.display = 'flex';
                } else {
                    alert("Error: " + (data.error || "Unknown error"));
                }
            } catch (error) {
                console.error(error);
                alert("Connection failed. Check console.");
            } finally {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('btnGo').disabled = false;
            }
        }
    </script>
</body>
</html>
