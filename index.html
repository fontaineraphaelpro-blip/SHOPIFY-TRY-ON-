import os
import io
import time
import sqlite3
import shopify
import replicate
from typing import Optional, Dict
from fastapi import FastAPI, Request, Form, File, UploadFile
from fastapi.responses import HTMLResponse, JSONResponse, FileResponse
from fastapi.middleware.cors import CORSMiddleware
from fastapi.templating import Jinja2Templates

# --- CONFIGURATION ---
SHOPIFY_API_KEY = os.getenv("SHOPIFY_API_KEY")
SHOPIFY_API_SECRET = os.getenv("SHOPIFY_API_SECRET")
# Token Replicate
REPLICATE_API_TOKEN = os.getenv("REPLICATE_API_TOKEN") 
MODEL_ID = "cuuupid/idm-vton:c871bb9b0466074280c2aec71dc6746146c6374507d3b0704332973e44075193"

app = FastAPI()
app.add_middleware(CORSMiddleware, allow_origins=["*"], allow_methods=["*"], allow_headers=["*"])
templates = Jinja2Templates(directory=".")

# --- DATABASE ---
def get_token_db(shop):
    try:
        with sqlite3.connect("database.db") as conn:
            cur = conn.cursor()
            cur.execute("SELECT token FROM shops WHERE domain = ?", (shop,))
            row = cur.fetchone()
            return row[0] if row else None
    except: return None

# --- HELPERS ---
def clean_shop(url):
    return url.replace("https://", "").replace("http://", "").strip("/") if url else ""

# Middleware pour autoriser l'iframe dans Shopify
@app.middleware("http")
async def add_csp_header(request: Request, call_next):
    response = await call_next(request)
    shop = request.query_params.get("shop", "")
    if shop:
        response.headers["Content-Security-Policy"] = f"frame-ancestors https://{shop} https://admin.shopify.com;"
    return response

# --- ROUTES ---

@app.get("/styles.css")
def styles(): return FileResponse('styles.css', media_type='text/css')

@app.get("/app.js")
def javascript(): return FileResponse('app.js', media_type='application/javascript')

@app.get("/", response_class=HTMLResponse)
async def index(request: Request):
    # Charge le fichier HTML unique
    return templates.TemplateResponse("index.html", {"request": request})

# --- API GENERATE (LE COEUR DU SYSTEME) ---
@app.post("/api/generate")
async def generate(
    shop: str = Form(...),
    person_image: UploadFile = File(...),
    clothing_url: str = Form(...) # On force l'URL ici car le widget envoie toujours une URL
):
    print(f"üöÄ RE√áU: Shop={shop} | V√™tement={clothing_url}")
    
    shop = clean_shop(shop)
    token = get_token_db(shop)
    
    # 1. S√©curit√© simple : est-ce que la boutique a install√© l'app ?
    if not token:
        print("‚ùå ERREUR: Boutique non reconnue dans la DB")
        return JSONResponse({"error": "App non install√©e ou token manquant."}, status_code=403)

    try:
        # 2. V√©rification Cr√©dits Shopify
        shopify.Session.setup(api_key=SHOPIFY_API_KEY, secret=SHOPIFY_API_SECRET)
        session = shopify.Session(shop, "2024-10", token)
        shopify.ShopifyResource.activate_session(session)
        
        # R√©cup√©ration cr√©dits
        meta = shopify.Metafield.find(namespace="virtual_try_on", key="wallet")
        credits = int(float(meta[0].value)) if meta else 0
        
        if credits < 1:
            return JSONResponse({"error": "Plus de cr√©dits disponibles."}, status_code=402)

        # 3. Appel Replicate
        # On lit l'image utilisateur en RAM
        person_bytes = await person_image.read()
        
        print("ü§ñ Envoi √† Replicate...")
        output = replicate.run(
            MODEL_ID,
            input={
                "human_img": io.BytesIO(person_bytes),
                "garm_img": clothing_url, # On passe l'URL directe de Shopify
                "garment_des": "upper_body",
                "category": "upper_body",
                "crop": False,
                "seed": 42
            }
        )
        
        result_url = str(output[0]) if isinstance(output, list) else str(output)
        print(f"‚úÖ SUCC√àS: {result_url}")

        # 4. D√©bit Cr√©dit
        new_credits = credits - 1
        # Mise √† jour metafield
        m = shopify.Metafield()
        m.namespace = "virtual_try_on"
        m.key = "wallet"
        m.value = new_credits
        m.type = "integer"
        m.save()

        return {"result_image_url": result_url}

    except Exception as e:
        print(f"üî• CRASH: {str(e)}")
        return JSONResponse({"error": str(e)}, status_code=500)
