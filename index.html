<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTON App</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
        
        /* MODE CLIENT (Widget) */
        body.client-mode { background: transparent; }
        body.client-mode .admin-panel { display: none !important; }
        body.client-mode .client-panel { display: flex; flex-direction: column; height: 100vh; }

        /* Interface Client */
        .client-panel { display: none; padding: 20px; box-sizing: border-box; text-align: center; }
        
        .grid-upload {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;
        }
        .box {
            background: white; border: 2px dashed #ccc; border-radius: 10px;
            height: 150px; display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .box img { width: 100%; height: 100%; object-fit: contain; }
        
        .btn-main {
            background: black; color: white; border: none; padding: 15px;
            width: 100%; border-radius: 50px; font-size: 16px; font-weight: bold;
            cursor: pointer;
        }
        .btn-main:disabled { background: #ccc; }

        /* Loader */
        .loader { display: none; margin-top: 20px; }
        .spinner { width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid #000; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Resultat */
        #resultImage { max-width: 100%; border-radius: 10px; display: none; margin-top: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="clientZone" class="client-panel">
        <h3>Cabine d'Essayage</h3>
        
        <div class="grid-upload">
            <label class="box" for="userUpload">
                <img id="userPreview" style="display:none;">
                <span id="userText">üì∏ Ta Photo</span>
                <input type="file" id="userUpload" accept="image/*" style="display:none;">
            </label>

            <div class="box">
                <img id="productPreview">
            </div>
        </div>

        <button id="generateBtn" class="btn-main">G√©n√©rer l'Essayage ‚ú®</button>

        <div id="loader" class="loader">
            <div class="spinner"></div>
            <p>L'IA travaille... (10-15s)</p>
        </div>

        <img id="resultImage">
    </div>

    <div class="admin-panel" style="padding: 50px; text-align: center;">
        <h1>Dashboard Admin</h1>
        <p>Pour voir le widget, allez sur une page produit de votre boutique.</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const mode = params.get('mode');
            const shop = params.get('shop');
            const productImg = params.get('product_image');

            // 1. D√âTECTION MODE
            if (mode === 'client') {
                document.body.classList.add('client-mode');
                document.getElementById('clientZone').style.display = 'flex';
                
                // Afficher l'image produit re√ßue de Shopify
                if (productImg) {
                    document.getElementById('productPreview').src = productImg;
                }
            }

            // 2. PREVIEW PHOTO UTILISATEUR
            const userUpload = document.getElementById('userUpload');
            const userPreview = document.getElementById('userPreview');
            const userText = document.getElementById('userText');

            userUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        userPreview.src = ev.target.result;
                        userPreview.style.display = 'block';
                        userText.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // 3. G√âN√âRATION
            document.getElementById('generateBtn').addEventListener('click', async () => {
                const file = userUpload.files[0];
                if (!file) return alert("Ajoute ta photo d'abord !");
                if (!shop) return alert("Erreur: Boutique non d√©tect√©e.");

                // UI Loading
                const btn = document.getElementById('generateBtn');
                btn.disabled = true;
                btn.innerText = "Traitement en cours...";
                document.getElementById('loader').style.display = 'block';
                document.getElementById('resultImage').style.display = 'none';

                // Pr√©paration Donn√©es
                const formData = new FormData();
                formData.append('shop', shop);
                formData.append('person_image', file);
                formData.append('clothing_url', productImg); // On renvoie l'URL re√ßue

                try {
                    const res = await fetch('/api/generate', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await res.json();

                    if (!res.ok) throw new Error(data.error || "Erreur serveur");

                    // Succ√®s
                    const img = document.getElementById('resultImage');
                    img.src = data.result_image_url;
                    img.style.display = 'block';

                } catch (err) {
                    alert("Oups : " + err.message);
                } finally {
                    btn.disabled = false;
                    btn.innerText = "G√©n√©rer l'Essayage ‚ú®";
                    document.getElementById('loader').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
