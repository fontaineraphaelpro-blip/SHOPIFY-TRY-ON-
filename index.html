<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DEBUG MODE</title>
    <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js" data-api-key="{{ api_key }}"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: white; }
        .box { border: 2px solid black; padding: 15px; margin-bottom: 15px; background: #f0f0f0; }
        button { 
            width: 100%; padding: 20px; background: blue; color: white; 
            font-size: 20px; border: none; cursor: pointer; display: block;
        }
        button:hover { background: darkblue; }
        #log { background: #000; color: lime; padding: 10px; height: 150px; overflow: auto; font-family: monospace; }
    </style>
</head>
<body>

    <h1>üö® MODE D√âPANNAGE</h1>
    
    <div id="log">Logs syst√®me...<br></div>

    <div class="box">
        <h3>1. Ta Photo</h3>
        <input type="file" id="uImg" accept="image/*">
    </div>

    <div class="box">
        <h3>2. V√™tement</h3>
        <input type="file" id="cImg" accept="image/*">
        <input type="hidden" id="autoUrl"> 
    </div>

    <button id="btnDebug" type="button">LANCER LE TEST üöÄ</button>

    <div id="resZone" style="display:none; margin-top:20px;">
        <h3>R√©sultat :</h3>
        <img id="resImg" style="width:100%; border: 3px solid red;">
    </div>

    <script>
        function log(msg) {
            const el = document.getElementById('log');
            el.innerHTML += "> " + msg + "<br>";
            console.log(msg);
        }

        document.addEventListener("DOMContentLoaded", function() {
            log("Page charg√©e.");
            
            const params = new URLSearchParams(window.location.search);
            const shop = params.get('shop');
            const product_image = params.get('product_image');

            log("Shop: " + (shop || "NON D√âTECT√â"));
            
            if(product_image) {
                log("V√™tement automatique d√©tect√©");
                document.getElementById('autoUrl').value = product_image;
            }

            const btn = document.getElementById('btnDebug');
            
            // TEST DE CLIC DIRECT
            btn.onclick = async function() {
                log("üî¥ CLIC RE√áU ! Lancement...");
                btn.disabled = true;
                btn.innerText = "Traitement en cours...";

                const uFile = document.getElementById('uImg').files[0];
                const cFile = document.getElementById('cImg').files[0];
                const autoUrl = document.getElementById('autoUrl').value;

                if(!shop) { alert("Erreur: Shop manquant"); btn.disabled=false; return; }
                if(!uFile) { alert("Mets une photo !"); btn.disabled=false; return; }

                log("Pr√©paration des donn√©es...");
                const formData = new FormData();
                formData.append("shop", shop);
                formData.append("person_image", uFile);

                if(autoUrl) {
                    log("Envoi URL v√™tement: " + autoUrl);
                    formData.append("clothing_url", autoUrl);
                } else if(cFile) {
                    log("Envoi Fichier v√™tement");
                    formData.append("clothing_file", cFile);
                } else {
                    alert("Mets un v√™tement !"); btn.disabled=false; return;
                }

                try {
                    log("üì° Envoi au serveur (Fetch)...");
                    
                    // On force le mode cors pour √©viter le blocage
                    const res = await fetch('/api/generate', {
                        method: 'POST',
                        body: formData,
                        mode: 'cors' 
                    });

                    log("R√©ponse serveur : " + res.status);

                    if(!res.ok) {
                        const txt = await res.text();
                        throw new Error("Erreur serveur: " + txt);
                    }

                    const data = await res.json();
                    log("JSON re√ßu: " + JSON.stringify(data));

                    if(data.result_image_url) {
                        const img = document.getElementById('resImg');
                        img.src = data.result_image_url;
                        document.getElementById('resZone').style.display = 'block';
                        log("‚úÖ IMAGE AFFICH√âE !");
                    } else {
                        throw new Error("Pas d'URL dans la r√©ponse");
                    }

                } catch(e) {
                    log("‚ò†Ô∏è ERREUR: " + e.message);
                    alert("Erreur: " + e.message);
                } finally {
                    btn.disabled = false;
                    btn.innerText = "R√âESSAYER";
                }
            };
        });
    </script>
</body>
</html>
