<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StyleLab VTON</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

    <div id="admin-dashboard" class="container">
        
        <div class="admin-header">
            <div class="brand">
                <div class="brand-icon"><i class="fa-solid fa-shirt"></i><i class="fa-solid fa-bolt" style="font-size: 0.7em; margin-left: -5px;"></i></div>
                VTON Magic Admin
            </div>
            <div class="status-badge">
                <span class="dot"></span> System Active
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="credit-card main-stat">
                <div class="card-label">CREDITS REMAINING</div>
                <div class="credit-amount">{{ credits }}</div>
                <div class="card-sub"><i class="fa-solid fa-infinity"></i> No Expiration Date</div>
                <div class="shiny-effect"></div>
            </div>

            <div class="packs-container">
                <div class="pack-card">
                    <div class="pack-header">
                        <div class="pack-title">Starter</div>
                        <div class="pack-credits">10 Credits</div>
                    </div>
                    <div class="pack-pricing">
                        <div class="pack-price">€4.99</div>
                        <div class="unit-price">approx €0.50 / try-on</div>
                    </div>
                    <button class="pack-btn btn-outline" onclick="buyCredits(10)">Select Pack</button>
                </div>

                <div class="pack-card popular">
                    <div class="popular-badge"><i class="fa-solid fa-fire"></i> Best Seller</div>
                    <div class="save-badge">SAVE 33%</div>
                    <div class="pack-header">
                        <div class="pack-title" style="color:var(--primary)">Growth</div>
                        <div class="pack-credits">30 Credits</div>
                    </div>
                    <div class="pack-pricing">
                        <div class="pack-price" style="color:var(--primary)">€9.99</div>
                        <div class="unit-price">approx €0.33 / try-on</div>
                    </div>
                    <button class="pack-btn btn-fill" onclick="buyCredits(30)">Top Up Now <i class="fa-solid fa-arrow-right"></i></button>
                </div>

                <div class="pack-card">
                    <div class="save-badge best-value">BEST VALUE</div>
                    <div class="pack-header">
                        <div class="pack-title">Business</div>
                        <div class="pack-credits">100 Credits</div>
                    </div>
                    <div class="pack-pricing">
                        <div class="pack-price">€19.99</div>
                        <div class="unit-price">approx €0.20 / try-on</div>
                    </div>
                    <button class="pack-btn btn-outline" onclick="buyCredits(100)">Select Pack</button>
                </div>
            </div>
        </div>

        <div class="preview-section">
            <h3 class="preview-title">
                <i class="fa-solid fa-mobile-screen"></i> Customer View (Mobile Preview)
            </h3>
        </div>
    </div>


    <div id="studio-interface">
        
        <form id="tryon-form" onsubmit="handleGenerate(event)">
            
            <div class="client-grid">
                
                <div class="upload-card" id="card-human" onclick="document.getElementById('human_image').click()">
                    <div class="step-badge">1</div>
                    <input type="file" id="human_image" name="human_image" accept="image/*" required onchange="previewImage(this, 'card-human')">
                    <div class="upload-content">
                        <i class="fa-regular fa-user upload-icon"></i>
                        <div class="upload-text">Upload<br>Your Photo</div>
                        <div class="upload-subtext">Selfie or full body</div>
                    </div>
                    <img src="" alt="Me">
                </div>

                <div class="math-sign"><i class="fa-solid fa-plus"></i></div>

                <div class="upload-card" id="card-garment" onclick="document.getElementById('garment_image').click()">
                    <div class="step-badge">2</div>
                    <input type="file" id="garment_image" name="garment_image" accept="image/*" required onchange="previewImage(this, 'card-garment')">
                    <div class="upload-content">
                        <i class="fa-solid fa-shirt upload-icon"></i>
                        <div class="upload-text">Upload<br>Garment</div>
                        <div class="upload-subtext">Flat lay or mannequin</div>
                    </div>
                    <img src="" alt="Cloth">
                </div>

                <div class="math-sign"><i class="fa-solid fa-equals"></i></div>

                <div class="upload-card result-card" id="resZone">
                    <div class="step-badge result-badge"><i class="fa-solid fa-check"></i></div>
                    <div class="upload-content" id="resContent">
                        <i class="fa-solid fa-wand-magic-sparkles upload-icon magic-icon"></i>
                        <div class="upload-text" id="resText">AI Result<br>Will appear here</div>
                    </div>
                    <img id="resultImage" src="" alt="Result">
                </div>

            </div>

            <button type="submit" class="cta-button" id="genBtn">
                Try On Now <i class="fa-solid fa-sparkles fa-bounce" style="--fa-animation-duration: 2s;"></i>
            </button>
             <p class="credits-notice"><i class="fa-solid fa-circle-info"></i> Uses 1 credit per try-on</p>

        </form>
    </div>


    <script>
        // --- 1. DETECTION DU MODE (ADMIN vs CLIENT) ---
        // Astuce pour le test : Si l'écran est petit (mobile) OU si l'URL a ?mode=client -> on affiche le client.
        const urlParams = new URLSearchParams(window.location.search);
        const isClientMode = urlParams.get('mode') === 'client' || window.innerWidth < 768; 

        if (isClientMode) {
            document.body.classList.add('client-mode');
        }

        // Animation d'apparition
        window.addEventListener('load', () => {
            document.body.classList.add('loaded');
        });


        // --- 2. FONCTIONS ADMIN (Paiement) ---
        async function buyCredits(amount) {
            const btn = event.target;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Redirecting...';
            btn.disabled = true;

            try {
                const response = await fetch(`/buy_credits?amount=${amount}`, { method: 'POST' });
                
                // GESTION DES ERREURS 401 (Session expirée)
                if (response.status === 401) {
                    // Shopify demande un rechargement pour rafraîchir la session
                     const data = await response.json();
                     if(data.force_redirect) {
                         window.top.location.href = data.force_redirect;
                         return;
                     }
                }
                
                const data = await response.json();
                
                if (data.confirmation_url) {
                    // Redirection vers Shopify pour valider le paiement
                    window.top.location.href = data.confirmation_url;
                } else {
                    alert("Error: " + (data.error || "Unknown error"));
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                alert("Connection error with the server.");
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }


        // --- 3. FONCTIONS CLIENT (Upload & Preview) ---
        function previewImage(input, cardId) {
            const card = document.getElementById(cardId);
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = card.querySelector('img');
                    img.src = e.target.result;
                    img.style.display = 'block'; // Affiche l'image
                    card.classList.add('has-image'); // Ajoute la classe CSS pour le style
                }
                reader.readAsDataURL(file);
            }
        }

        async function handleGenerate(e) {
            e.preventDefault();
            
            const btn = document.getElementById('genBtn');
            const resZone = document.getElementById('resZone');
            const resImg = document.getElementById('resultImage');
            const resContent = document.getElementById('resContent');

            // Validation basique
            if(!document.getElementById('human_image').files[0] || !document.getElementById('garment_image').files[0]) {
                alert("Please upload both photos first.");
                return;
            }

            // UI Loading
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating Magic...';
            btn.classList.add('loading');
            resZone.classList.add('loading-zone');

            const formData = new FormData(e.target);

            try {
                // Appel API vers ton backend Python
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();

                if (data.result_image_url) {
                    // Succès !
                    resImg.src = data.result_image_url;
                    // On attend que l'image soit chargée pour l'afficher
                    resImg.onload = () => {
                         resImg.style.display = 'block';
                         resZone.classList.add('has-image');
                         resZone.classList.remove('loading-zone');
                         resContent.style.display = 'none'; // Cache le texte "AI Result"
                         btn.innerHTML = 'Try Another Outfit <i class="fa-solid fa-rotate-right"></i>';
                         btn.classList.remove('loading');
                    };
                } else {
                    alert("Error: " + (data.error || "Generation failed. Please try again."));
                    resZone.classList.remove('loading-zone');
                    btn.innerHTML = 'Try On Now <i class="fa-solid fa-sparkles"></i>';
                    btn.classList.remove('loading');
                }

            } catch (err) {
                alert("Error connecting to server. Please check your connection.");
                console.error(err);
                resZone.classList.remove('loading-zone');
                btn.innerHTML = 'Try On Now <i class="fa-solid fa-sparkles"></i>';
                btn.classList.remove('loading');
            }
        }
    </script>
</body>
</html>
